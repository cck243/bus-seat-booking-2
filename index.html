<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // 🔧 PASTE YOUR EXACT CONFIG HERE (from Firebase Console → Project settings → Web app → CDN)
  const firebaseConfig = {
    apiKey: "PASTE_YOUR_REAL_API_KEY_HERE",
    authDomain: "your-project-id.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "XXXXXXXXXXXX",
    appId: "1:XXXXXXXXXXXX:web:YYYYYYYYYYYYYYYY"
  };

  // Basic sanity checks to catch typos early
  function validateConfig(cfg) {
    const problems = [];
    if (!cfg.apiKey || cfg.apiKey.length < 30) problems.push("apiKey looks wrong/empty");
    if (!cfg.authDomain || !cfg.authDomain.includes("firebaseapp.com")) problems.push("authDomain looks wrong");
    if (!cfg.projectId) problems.push("projectId missing");
    if (!cfg.appId || !cfg.appId.includes(":")) problems.push("appId looks wrong");
    return problems;
  }

  const issues = validateConfig(firebaseConfig);
  if (issues.length) {
    console.warn("⚠️ Firebase config issues:", issues.join(", "));
  }

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Show/hide admin UI on auth state
  const adminPanel = document.getElementById("admin-panel");
  const adminLogin = document.getElementById("admin-login");
  onAuthStateChanged(auth, (user) => {
    if (user) {
      adminLogin?.classList.add("hidden");
      adminPanel?.classList.remove("hidden");
      // Optionally load your data here:
      if (window.loadBuses) window.loadBuses();
      if (window.loadRoutes) window.loadRoutes();
    } else {
      adminPanel?.classList.add("hidden");
      adminLogin?.classList.remove("hidden");
    }
  });

  // Replace your old adminLogin() with a secure version
  window.adminLogin = async function () {
    const email = document.getElementById("admin-username")?.value?.trim();
    const pass  = document.getElementById("admin-password")?.value;
    if (!email || !pass) return alert("Enter Email and Password");

    try {
      await signInWithEmailAndPassword(auth, email, pass);
      // Success → onAuthStateChanged will switch the UI
    } catch (e) {
      // Helpful guidance for common cases
      const msg = (e && e.code) ? e.code : (e && e.message) ? e.message : String(e);
      if (String(msg).includes("api-key-not-valid")) {
        alert("Login failed: Invalid API key.\n\nFix:\n1) Paste the correct firebaseConfig from Firebase Console.\n2) If your API key is restricted, allow Identity Toolkit API and your domain.\n3) Ensure authDomain/projectId match your project.");
      } else if (String(msg).includes("auth/user-not-found")) {
        alert("User not found. Create the admin user in Firebase Console → Authentication → Users.");
      } else if (String(msg).includes("auth/invalid-email")) {
        alert("Invalid email format.");
      } else if (String(msg).includes("auth/wrong-password")) {
        alert("Wrong password.");
      } else {
        alert("Login failed: " + msg);
      }
      console.error(e);
    }
  };

  // Optional: add a logout hook (if you have a button calling logoutAdmin())
  window.logoutAdmin = async function () {
    await signOut(auth);
  };

  // Example CRUD (only if you already wired Buses/Routes UI):
  window.loadBuses = async function () {
    const snap = await getDocs(collection(db, "buses"));
    const tbody = document.querySelector("#buses-tab table tbody, #buses-table");
    if (!tbody) return;
    tbody.innerHTML = "";
    snap.forEach(d => {
      const b = d.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.id}</td>
        <td>${b.name || ""}</td>
        <td>${b.capacity || ""}</td>
        <td>${b.type || ""}</td>
        <td>
          <button onclick="editBus('${d.id}')">Edit</button>
          <button onclick="deleteBus('${d.id}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  };

  window.addNewBus = async function () {
    const name = prompt("Bus name?");
    const capacity = prompt("Capacity?");
    const type = prompt("Type (AC/Non-AC)?");
    if (!name) return;
    await addDoc(collection(db, "buses"), { name, capacity, type });
    window.loadBuses();
  };

  window.editBus = async function (id) {
    const name = prompt("New name?");
    if (!name) return;
    await updateDoc(doc(db, "buses", id), { name });
    window.loadBuses();
  };

  window.deleteBus = async function (id) {
    await deleteDoc(doc(db, "buses", id));
    window.loadBuses();
  };

  window.loadRoutes = async function () {
    const snap = await getDocs(collection(db, "routes"));
    const tbody = document.querySelector("#routes-tab table tbody, #routes-table");
    if (!tbody) return;
    tbody.innerHTML = "";
    snap.forEach(d => {
      const r = d.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.id}</td>
        <td>${r.from || ""}</td>
        <td>${r.to || ""}</td>
        <td>${r.distance || ""}</td>
        <td>${r.duration || ""}</td>
        <td>
          <button onclick="editRoute('${d.id}')">Edit</button>
          <button onclick="deleteRoute('${d.id}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  };

  window.addNewRoute = async function () {
    const from = prompt("From?");
    const to = prompt("To?");
    const distance = prompt("Distance?");
    const duration = prompt("Duration?");
    if (!from || !to) return;
    await addDoc(collection(db, "routes"), { from, to, distance, duration });
    window.loadRoutes();
  };

  window.editRoute = async function (id) {
    const duration = prompt("New duration?");
    if (!duration) return;
    await updateDoc(doc(db, "routes", id), { duration });
    window.loadRoutes();
  };

  window.deleteRoute = async function (id) {
    await deleteDoc(doc(db, "routes", id));
    window.loadRoutes();
  };
</script>
